define EXPR
	let sources = import <libdb.so/nix/sources.nix> { };
			nixpkgs = import sources.nixpkgs {
				system = "i686-linux";
			};
		in (nixpkgs.callPackage ./v86.nix { }).baseConfig
endef

export EXPR

all: v86.base.config # v86-config-base.nix

v86.base.config: v86.nix
	sed \
		-e 's/\(CONFIG_KERNEL_XZ\)=y/\1=n/g' \
		-e 's/\(CONFIG_ARCH_SUPPORTS_ACPI\)=y/\1=n/g' \
		$$(nix-build --no-out-link -E "$$EXPR") > $@

# v86-config-base.nix: v86.nix
# 	echo "# Generated by Makefile. DO NOT EDIT." > $@
# 	echo "{" >> $@
# 	sed -n \
# 		's/^CONFIG_\([A-Z_]*\)=\([ynm]\)$/\t\1 = { tristate = "\2"; optional = false; };/p' \
# 		v86.base.config >> $@
# 	echo "}" >> $@
